// Tallest stepped pyramid the pharaoh can build with 2,500,000 stones
// OpenSCAD file (units: millimetres)
// Each large stone is a cube with side = 500 mm (0.5 m).
// Stacking rule => each layer is a contiguous k x k array of stones,
// next layer uses (k-1) x (k-1) stones centered above, so layers are
// solid slabs of thickness = stone size. No internal voids.
// The largest base k satisfying sum_{m=1..k} m^2 <= 2,500,000 is k = 195.
// Total stones used = sum_{m=1..195} m^2 = 2,490,670
// Total volume of stones = 2,490,670 * (0.5 m)^3 = 311,333.75 m^3
//
// The model below builds the stepped pyramid as 195 stacked rectangular
// prisms (one per layer). Bottom face sits on z = 0. Pyramid is centered
// on X=0,Y=0. +Y is north (as requested).

stone_mm = 500;                   // 500 mm = 0.5 m per cube side
base_layers = 195;                // maximal base side in stones
// exact total stones formula: sum_{m=1..n} m^2 = n(n+1)(2n+1)/6
total_stones = base_layers*(base_layers+1)*(2*base_layers+1)/6;
total_volume_m3 = total_stones * pow(stone_mm/1000, 3);

// Echo values to OpenSCAD console for verification (millimetre-accurate)
echo(str("stone_mm = ", stone_mm, " mm"));
echo(str("base_layers = ", base_layers));
echo(str("total_stones = ", total_stones));
echo(str("total_volume_m3 = ", total_volume_m3, " m^3"));

// Parameters for rendering
layer_color = [0.85,0.72,0.53];   // sandstone-like colour for visualization
show_axes = true;
arrow_thickness = 100;            // mm for axis arrow stem
arrow_head_len = 300;             // mm
arrow_head_w = 200;               // mm

module pyramid_layers()
{
    // Build each layer as a single rectangular prism (optimized)
    // Layer k (stone count per side) has horizontal size k*stone_mm and
    // thickness stone_mm. Bottom layer (k=base_layers) is at z=0.
    for (k = [base_layers : -1 : 1]) {
        size_xy = k * stone_mm;
        zpos = (base_layers - k) * stone_mm; // bottom layer zpos=0
        translate([ -size_xy/2, -size_xy/2, zpos ])
            cube([ size_xy, size_xy, stone_mm ], center = false);
    }
}

module north_arrow()
{
    // Simple arrow pointing along +Y to indicate north
    // Stem
    translate([0, base_layers*stone_mm/2 + 400, stone_mm]) // slightly above base
        color([0,0,0])
        union() {
            translate([-arrow_thickness/2, 0, 0])
                cube([arrow_thickness, arrow_head_len, arrow_thickness], center=false);
            // Head
            translate([ -arrow_head_w/2, arrow_head_len, -arrow_head_w/2 ])
                rotate([0,0,0])
                    hull() {
                        translate([0,0,0]) cube([arrow_head_w, 1, arrow_head_w], center=false);
                        translate([arrow_head_w/2, arrow_head_len/2, 0])
                            sphere(r = arrow_head_w/2, $fn=24);
                    }
        }
    // Small label "N" as a flat block (no text object to keep portability)
    translate([-200, base_layers*stone_mm/2 + arrow_head_len + 700, stone_mm])
        cube([400, 50, 10], center=false); // placeholder block under arrow
}

// Render final object
color(layer_color)
    pyramid_layers();

if (show_axes) {
    // Draw coordinate axes (thin rods): +X East, +Y North, +Z Up
    // X axis (red)
    color([1,0,0])
        translate([base_layers*stone_mm/2 + 200, 0, stone_mm/2])
            rotate([0,90,0])
                cylinder(h = base_layers*stone_mm + 400, r = 20, $fn=32);
    // Y axis (green) and arrow for north
    color([0,0.5,0])
        translate([0, base_layers*stone_mm/2 + 200, stone_mm/2])
            rotate([90,0,0])
                cylinder(h = base_layers*stone_mm + 400, r = 20, $fn=32);
    north_arrow();
    // Z axis (blue)
    color([0,0,1])
        translate([ base_layers*stone_mm/2 + 200, -200, stone_mm/2 ])
            rotate([0,0,0])
                cylinder(h = 2000, r = 20, $fn=32);
}