// Tallest step pyramid the pharaoh can build given constraints
// Units: meters (SI). All coordinates and sizes are exact to millimeter (3 decimal places).
//
// Constraints applied:
//  - Available cut stones: 150000 (not limiting here)
//  - Army: 100000 men, each stone needs 10 men -> at most 10000 stones may be handled
//  - Stability rule: each stone above must have its four bottom corners resting on centers of four stones below.
//    This produces a square, stepped pyramid with layer sizes n, n-1, ..., 1 (in stones).
//
// Computation:
//  - With a cube stone side s = 0.500 m, and maximum stones <= 10000, the largest integer base size n
//    satisfying sum_{k=1..n} k^2 <= 10000 is n = 30 (sum = 9455 stones).
//  - Total stone count used: 9455
//  - Pyramid physical dimensions:
//      base side length = n * s = 30 * 0.5 = 15.000 m
//      height (top of top stone) = n * s = 15.000 m
//
// This OpenSCAD file produces:
//  - The full stepped pyramid built from individual stone cubes (each 0.500 m cube), positioned precisely.
//  - The smooth exterior pyramid (a continuous 4-face pyramid) whose base is the same square and whose apex
//    is at the overall pyramid top. This represents the marble facade shape that will cover the external stones.
//
// Notes for the stonemason's CAD:
//  - Every stone is placed precisely (centers and sizes given to millimeter precision).
//  - The facade polyhedron is exact and can be used to derive each exposed stone's cover wedge geometry.
//
// No other output or explanatory text is included; the file below is pure OpenSCAD.

/////////////////////////////////////////////////////////////
// Parameters (change only if recomputing with different constraints)
s = 0.500;              // stone cube side length in meters (500 mm)
n_layers = 30;          // number of layers (base is n_layers x n_layers stones)
stone_count = n_layers*(n_layers+1)*(2*n_layers+1)/6; // sum of squares: total stones used

// Derived sizes
base_side = n_layers * s;   // meters
height_total = n_layers * s; // meters

// Small epsilon to avoid coincident-face rendering issues (kept extremely small)
eps = 1e-6;

// Module: single stone (cube) centered on its local origin
module stone() {
    // Using center = true places the cube center at the translate location we supply
    cube([s, s, s], center = true);
}

// Module: the stepped pyramid from individual stones
module stepped_pyramid() {
    // For each layer k = 0 .. n_layers-1 (ground layer k=0)
    // layer_size = n_layers - k (stones per side in that layer)
    // stone center coordinates:
    //   x = (i - (layer_size-1)/2) * s  for i in 0..layer_size-1
    //   y = (j - (layer_size-1)/2) * s  for j in 0..layer_size-1
    //   z = s/2 + k*s                    center height for layer k
    for (k = [0 : n_layers - 1]) {
        layer_size = n_layers - k;
        // precompute offset term (centering) to millimetre precision
        offset = (layer_size - 1) / 2.0 * s;
        zc = (s/2) + k * s;
        for (i = [0 : layer_size - 1]) {
            xi = (i * s) - offset;
            for (j = [0 : layer_size - 1]) {
                yj = (j * s) - offset;
                translate([xi, yj, zc])
                    stone();
            }
        }
    }
}

// Module: smooth exterior pyramid (facade) that exactly covers the stepped pyramid
module smooth_facade() {
    L = base_side; // base side length in meters
    H = height_total;
    // Base corners (z=0), ordered CCW looking from above
    p0 = [-L/2, -L/2, 0];
    p1 = [ L/2, -L/2, 0];
    p2 = [ L/2,  L/2, 0];
    p3 = [-L/2,  L/2, 0];
    apex = [0, 0, H];
    // Use polyhedron with base quad and four triangular faces
    polyhedron(
        points = [p0, p1, p2, p3, apex],
        faces = [
            [0,1,2,3], // base
            [0,4,1],
            [1,4,2],
            [2,4,3],
            [3,4,0]
        ]
    );
}

// Visual assembly:
// - Show stepped stones in a neutral stone color
// - Show smooth facade as a slightly translucent outer shell (for reference to the mason)
//
// If the CAD user prefers only the facade, they can comment out the stepped_pyramid() line.

translate([0,0,0])
union() {
    // Stepped stones
    // Slightly offset by an epsilon on z to avoid coplanar face glitches when both objects are rendered together.
    color([0.75, 0.70, 0.65])  // sandstone-like color
        stepped_pyramid();

    // Smooth facade (translucent to allow inspection of stones)
    // The small translate in Z by +eps avoids coincident-face rendering issues in some viewers.
    color([1, 1, 1, 0.35])   // white marble color with transparency
        translate([0, 0, eps])
            smooth_facade();
}